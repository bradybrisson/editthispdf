<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF Editor + Whiteout/Text Boxes</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; }
    #pdf-container {
      position: relative;
      border: 1px solid #ccc;
      margin-top: 1em;
      width: 600px;
      height: 800px;
      overflow: hidden;
    }
    #pdf-canvas {
      border: 1px solid black;
      display: block;
    }
    .annotation {
      position: absolute;
      box-sizing: border-box;
      resize: both;
      overflow: auto;
      user-select: text;
    }
    .whiteout, .textbox {
      cursor: move;
    }
    .whiteout {
      background: white;
      border: 1px solid #555;
      z-index: 10;
      min-width: 20px;
      min-height: 20px;
      resize: both;
      overflow: auto;
    }
    .whiteout::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-bottom: 8px solid #555;
      cursor: se-resize;
    }
    .textbox {
      border: 1px solid blue;
      background: rgba(255,255,255,0.85);
      padding: 2px 5px;
      outline: none;
      z-index: 20;
      min-width: 40px;
      min-height: 20px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #000000;
    }
    .textbox.selected {
      border: 2px solid #ff6b6b;
      box-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
    }
    #controls {
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e8eaed;
    }
    
    /* Google Material Design Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 20px;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 36px;
      box-sizing: border-box;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background-color: #1a73e8;
      color: white;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: #1557b0;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 2px 6px 2px rgba(60,64,67,.15);
    }
    
    .btn-secondary {
      background-color: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: #f8f9fa;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
    }
    
    .btn-outline {
      background-color: transparent;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }
    
    .btn-outline:hover:not(:disabled) {
      background-color: #f8f9fa;
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .file-input {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }
    
    .file-input-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background-color: white;
      color: #1a73e8;
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 36px;
      box-sizing: border-box;
    }
    
    .file-input-label:hover {
      background-color: #f8f9fa;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
    }
    
    .save-section {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    
    .filename-input {
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      font-size: 14px;
      min-width: 120px;
      height: 36px;
      box-sizing: border-box;
    }
    
    .filename-input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }
  </style>
</head>
<body>
  <h1>Welcome to EditThisPDF.com</h1>
  <div id="controls">
    <!-- Choose File Button -->
    <div class="file-input-wrapper">
      <input type="file" id="upload" class="file-input" accept="application/pdf" />
      <label for="upload" class="file-input-label">Choose PDF to Edit</label>
    </div>
    
    <!-- Add Text Box Button -->
    <button id="add-textbox" class="btn btn-secondary" disabled>Add Text Box</button>
    
    <!-- Add Whiteout Button -->
    <button id="add-whiteout" class="btn btn-secondary" disabled>Add Whiteout</button>
    
    <!-- Save Section -->
    <div class="save-section">
      <input type="text" id="filename" class="filename-input" value="edited" placeholder="New filename">
      <button id="save-pdf" class="btn btn-primary" disabled>Save PDF</button>
    </div>
  </div>
  
  <div id="text-styling" style="display: none; margin: 1em 0; padding: 16px; border: 1px solid #e8eaed; background: #f8f9fa; border-radius: 8px;">
    <h3 style="margin: 0 0 12px 0; font-family: 'Google Sans', Roboto, Arial, sans-serif; font-size: 16px; font-weight: 500; color: #202124;">Text Styling</h3>
    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
      <div style="display: flex; flex-direction: column; gap: 4px;">
        <label for="font-family" style="font-size: 12px; font-weight: 500; color: #5f6368;">Font Family</label>
        <select id="font-family" style="padding: 8px 12px; border: 1px solid #dadce0; border-radius: 4px; font-family: 'Google Sans', Roboto, Arial, sans-serif; font-size: 14px; min-width: 140px; height: 36px; box-sizing: border-box;">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
          <option value="Georgia">Georgia</option>
          <option value="Verdana">Verdana</option>
          <option value="Helvetica">Helvetica</option>
          <option value="Comic Sans MS">Comic Sans MS</option>
        </select>
      </div>
      <div style="display: flex; flex-direction: column; gap: 4px;">
        <label for="font-size" style="font-size: 12px; font-weight: 500; color: #5f6368;">Font Size</label>
        <input type="number" id="font-size" value="12" min="8" max="72" style="padding: 8px 12px; border: 1px solid #dadce0; border-radius: 4px; font-family: 'Google Sans', Roboto, Arial, sans-serif; font-size: 14px; width: 80px; height: 36px; box-sizing: border-box;">
      </div>
      <div style="display: flex; flex-direction: column; gap: 4px;">
        <label for="text-color" style="font-size: 12px; font-weight: 500; color: #5f6368;">Text Color</label>
        <input type="color" id="text-color" value="#000000" style="width: 36px; height: 36px; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer;">
      </div>
      <div style="display: flex; gap: 8px; align-items: end;">
        <button id="apply-styling" class="btn btn-primary" disabled>Apply Changes</button>
        <button id="clear-selection" class="btn btn-outline">Clear Selection</button>
      </div>
    </div>
  </div>
  
  <div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'] || window['pdfjsLib'] || window.pdfjsLib;
    // Set worker src
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

    const uploadInput = document.getElementById('upload');
    const addWhiteoutBtn = document.getElementById('add-whiteout');
    const addTextboxBtn = document.getElementById('add-textbox');
    const savePdfBtn = document.getElementById('save-pdf');
    const filenameInput = document.getElementById('filename');
    const pdfContainer = document.getElementById('pdf-container');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    
    // Text styling controls
    const textStylingDiv = document.getElementById('text-styling');
    const fontFamilySelect = document.getElementById('font-family');
    const fontSizeInput = document.getElementById('font-size');
    const textColorInput = document.getElementById('text-color');
    const applyStylingBtn = document.getElementById('apply-styling');
    const clearSelectionBtn = document.getElementById('clear-selection');
    
    let selectedTextbox = null;

    let pdfDoc = null;
    let pageViewport = null;
    let scale = 1.5;

    uploadInput.addEventListener('change', async (e) => {
      console.log('File selected');
      const file = e.target.files[0];
      if (!file) {
        console.log('No file');
        return;
      }
      if (file.type !== 'application/pdf') {
        alert('Please upload a PDF file');
        return;
      }
      const arrayBuffer = await file.arrayBuffer();
      console.log('Loaded arrayBuffer, size:', arrayBuffer.byteLength);
      try {
        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        pdfDoc = await loadingTask.promise;
        console.log('PDF loaded, pages:', pdfDoc.numPages);
      } catch (err) {
        console.error('Error loading PDF:', err);
        alert('Failed to load PDF');
        return;
      }

      // Render page 1
      await renderPage(1);
      addWhiteoutBtn.disabled = false;
      addTextboxBtn.disabled = false;
      savePdfBtn.disabled = false;
      // Remove previous annotations if any
      document.querySelectorAll('.annotation').forEach(el => el.remove());
    });

    async function renderPage(pageNum) {
      if (!pdfDoc) {
        console.log('No pdfDoc');
        return;
      }
      const page = await pdfDoc.getPage(pageNum);
      pageViewport = page.getViewport({ scale });

      canvas.width = pageViewport.width;
      canvas.height = pageViewport.height;
      pdfContainer.style.width = canvas.width + 'px';
      pdfContainer.style.height = canvas.height + 'px';

      const renderContext = {
        canvasContext: ctx,
        viewport: pageViewport
      };
      await page.render(renderContext).promise;
      console.log('Page rendered');
    }

    // Add Whiteout
    addWhiteoutBtn.addEventListener('click', () => {
      const wo = document.createElement('div');
      wo.className = 'annotation whiteout';
      wo.style.left = '60px';
      wo.style.top = '60px';
      wo.style.width = '150px';
      wo.style.height = '50px';
      makeDraggableResizable(wo);
      pdfContainer.appendChild(wo);
    });

    // Add Text Box
    addTextboxBtn.addEventListener('click', () => {
      const tb = document.createElement('div');
      tb.className = 'annotation textbox';
      tb.contentEditable = true;
      tb.style.left = '70px';
      tb.style.top = '70px';
      tb.style.width = '150px';
      tb.style.height = '30px';
      tb.innerText = 'Edit me';
      makeDraggableResizable(tb);
      addTextboxClickHandler(tb);
      pdfContainer.appendChild(tb);
      tb.focus();
      
      // Show styling controls when text box is added
      textStylingDiv.style.display = 'block';
    });

    // Draggable & resizable function
    function makeDraggableResizable(el) {
      let isDragging = false;
      let startX, startY, startLeft, startTop;

      el.addEventListener('mousedown', (e) => {
        // For whiteout, only drag if not on resize handle
        if (el.classList.contains('whiteout')) {
          const rect = el.getBoundingClientRect();
          const handleSize = 15;
          const isOnResizeHandle = (
            e.clientX > rect.right - handleSize && 
            e.clientY > rect.bottom - handleSize
          );
          if (isOnResizeHandle) {
            return; // Let CSS resize work
          }
        }

        // For text boxes, allow dragging but don't prevent text editing
        if (!el.classList.contains('textbox')) {
          e.preventDefault();
        }
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const rect = el.getBoundingClientRect();
        const contRect = pdfContainer.getBoundingClientRect();
        startLeft = rect.left - contRect.left;
        startTop = rect.top - contRect.top;
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const x = e.clientX - startX + startLeft;
        const y = e.clientY - startY + startTop;

        // Clip boundaries
        const boundedX = Math.max(0, Math.min(x, pdfContainer.clientWidth - el.offsetWidth));
        const boundedY = Math.max(0, Math.min(y, pdfContainer.clientHeight - el.offsetHeight));

        el.style.left = boundedX + 'px';
        el.style.top = boundedY + 'px';
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });
    }

    // Add click handler for text box selection
    function addTextboxClickHandler(textbox) {
      // Only handle selection on focus, not on mousedown
      textbox.addEventListener('focus', () => {
        selectTextbox(textbox);
      });
      
      // Handle selection when clicking outside the text content
      textbox.addEventListener('click', (e) => {
        // Only select if clicking on the border/background, not the text
        if (e.target === textbox) {
          selectTextbox(textbox);
        }
      });
    }

    // Select a text box
    function selectTextbox(textbox) {
      // Remove selection from all text boxes
      document.querySelectorAll('.textbox').forEach(tb => {
        tb.classList.remove('selected');
      });
      
      // Select the clicked text box
      textbox.classList.add('selected');
      selectedTextbox = textbox;
      
      // Update styling controls with current values
      fontFamilySelect.value = textbox.style.fontFamily || 'Arial';
      fontSizeInput.value = parseInt(textbox.style.fontSize) || 12;
      textColorInput.value = textbox.style.color || '#000000';
      
      // Enable apply button
      applyStylingBtn.disabled = false;
    }

    // Apply styling to selected text box
    function applyStylingToSelected() {
      if (selectedTextbox) {
        selectedTextbox.style.fontFamily = fontFamilySelect.value;
        selectedTextbox.style.fontSize = fontSizeInput.value + 'px';
        selectedTextbox.style.color = textColorInput.value;
      }
    }

    // Apply styling to selected text box (for button click)
    applyStylingBtn.addEventListener('click', applyStylingToSelected);

    // Live updates for font family
    fontFamilySelect.addEventListener('change', applyStylingToSelected);

    // Live updates for font size
    fontSizeInput.addEventListener('input', applyStylingToSelected);

    // Live updates for text color
    textColorInput.addEventListener('input', applyStylingToSelected);

    // Clear selection
    clearSelectionBtn.addEventListener('click', () => {
      document.querySelectorAll('.textbox').forEach(tb => {
        tb.classList.remove('selected');
      });
      selectedTextbox = null;
      applyStylingBtn.disabled = true;
    });

    // Click on PDF container to deselect
    pdfContainer.addEventListener('click', (e) => {
      if (e.target === pdfContainer) {
        document.querySelectorAll('.textbox').forEach(tb => {
          tb.classList.remove('selected');
        });
        selectedTextbox = null;
        applyStylingBtn.disabled = true;
      }
    });

    savePdfBtn.addEventListener('click', async () => {
      if (!pdfDoc) {
        alert('No PDF loaded');
        return;
      }
      
      try {
        console.log('Starting PDF save process...');
        const pdfBytes = await pdfDoc.getData();
        console.log('PDF bytes loaded, size:', pdfBytes.byteLength);
        
        const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);
        console.log('PDFLib document loaded');
        
        const page = pdfLibDoc.getPage(0);
        const { width, height } = page.getSize();
        console.log('Page size:', width, 'x', height);

      // Whiteouts first
      document.querySelectorAll('.whiteout').forEach(wo => {
        const left = parseFloat(wo.style.left);
        const top = parseFloat(wo.style.top);
        const w = wo.offsetWidth;
        const h = wo.offsetHeight;

        const x = (left / pdfContainer.clientWidth) * width;
        const y = height - ((top + h) / pdfContainer.clientHeight) * height;

        const rect = pdfLibDoc.getPage(0).drawRectangle({
          x, y,
          width: (w / pdfContainer.clientWidth) * width,
          height: (h / pdfContainer.clientHeight) * height,
          color: PDFLib.rgb(1,1,1),
          borderColor: PDFLib.rgb(1,1,1),
          borderWidth: 0,
          opacity: 1
        });
      });

      // Text boxes
      document.querySelectorAll('.textbox').forEach(tb => {
        const left = parseFloat(tb.style.left);
        const top = parseFloat(tb.style.top);
        const w = tb.offsetWidth;
        const h = tb.offsetHeight;
        const text = tb.innerText;

        const x = (left / pdfContainer.clientWidth) * width;
        const y = height - ((top + h) / pdfContainer.clientHeight) * height;

        // Get styling from the text box
        const fontSize = parseInt(tb.style.fontSize) || 12;
        const fontFamily = tb.style.fontFamily || 'Arial';
        let color = tb.style.color || '#000000';
        
        // Ensure color is a valid hex color
        if (!color.startsWith('#')) {
          color = '#000000';
        }
        if (color.length !== 7) {
          color = '#000000';
        }
        
        // Convert hex color to RGB with validation
        const hex = color.replace('#', '');
        const r = Math.max(0, Math.min(1, (parseInt(hex.substr(0, 2), 16) || 0) / 255));
        const g = Math.max(0, Math.min(1, (parseInt(hex.substr(2, 2), 16) || 0) / 255));
        const b = Math.max(0, Math.min(1, (parseInt(hex.substr(4, 2), 16) || 0) / 255));

        page.drawText(text, {
          x,
          y,
          size: fontSize,
          color: PDFLib.rgb(r, g, b),
          maxWidth: (w / pdfContainer.clientWidth) * width,
          lineHeight: fontSize * 1.2
        });
      });

        const newPdfBytes = await pdfLibDoc.save();
        console.log('PDF saved, size:', newPdfBytes.byteLength);
        
        const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        
        // Use custom filename or default
        const filename = filenameInput.value.trim() || 'edited';
        const finalFilename = filename.endsWith('.pdf') ? filename : filename + '.pdf';
        link.download = finalFilename;
        
        console.log('Downloading PDF as:', finalFilename);
        link.click();
        
        // Clean up the object URL
        setTimeout(() => URL.revokeObjectURL(link.href), 100);
        
        console.log('PDF download initiated successfully');
        
      } catch (error) {
        console.error('Error saving PDF:', error);
        alert('Error saving PDF: ' + error.message);
      }
    });
  </script>
</body>
</html>
