<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF.js + Whiteout + Editable Text Demo</title>
  <style>
    #pdf-container {
      position: relative;
      border: 1px solid #ccc;
      width: 600px;
      height: 800px;
      margin-bottom: 1em;
    }
    #pdf-canvas {
      border: 1px solid black;
      display: block;
    }
    .textbox, .whiteout {
      position: absolute;
      border: 1px solid;
      padding: 4px;
      min-width: 50px;
      min-height: 20px;
      resize: both;
      overflow: auto;
      box-sizing: border-box;
      user-select: text;
    }
    .textbox {
      border-color: blue;
      background: rgba(255,255,255,0.7);
      cursor: move;
      z-index: 20; /* On top */
      outline: none;
    }
    .whiteout {
      background: white;
      border-color: black;
      cursor: move;
      z-index: 10; /* Under textboxes */
    }
  </style>
</head>
<body>
  <h1>PDF.js + Whiteout + Editable Text Boxes</h1>

  <input type="file" id="upload" accept="application/pdf" />
  <button id="add-whiteout" disabled>Add Whiteout</button>
  <button id="add-textbox" disabled>Add Text Box</button>
  <button id="save-pdf" disabled>Save PDF with Annotations</button>

  <div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <!-- PDF.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <!-- pdf-lib for saving -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];

    const uploadInput = document.getElementById('upload');
    const addWhiteoutBtn = document.getElementById('add-whiteout');
    const addTextboxBtn = document.getElementById('add-textbox');
    const savePdfBtn = document.getElementById('save-pdf');
    const pdfContainer = document.getElementById('pdf-container');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');

    let pdfDoc = null;
    let scale = 1.5;
    let pageViewport = null;

    uploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || file.type !== 'application/pdf') {
        alert('Please upload a PDF file');
        return;
      }
      const arrayBuffer = await file.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

      renderPage(1);
      addWhiteoutBtn.disabled = false;
      addTextboxBtn.disabled = false;
      savePdfBtn.disabled = false;

      // Remove old whiteouts and textboxes
      document.querySelectorAll('.whiteout, .textbox').forEach(el => el.remove());
    });

    async function renderPage(pageNum) {
      const page = await pdfDoc.getPage(pageNum);
      pageViewport = page.getViewport({ scale: scale });
      canvas.width = pageViewport.width;
      canvas.height = pageViewport.height;
      pdfContainer.style.width = canvas.width + 'px';
      pdfContainer.style.height = canvas.height + 'px';

      const renderContext = {
        canvasContext: ctx,
        viewport: pageViewport
      };
      await page.render(renderContext).promise;
    }

    // Add whiteout box
    addWhiteoutBtn.addEventListener('click', () => {
      const whiteout = document.createElement('div');
      whiteout.className = 'whiteout';
      whiteout.style.left = '60px';
      whiteout.style.top = '60px';
      whiteout.style.width = '150px';
      whiteout.style.height = '50px';

      makeDraggableResizable(whiteout);

      pdfContainer.appendChild(whiteout);
    });

    // Add editable text box overlay (always on top)
    addTextboxBtn.addEventListener('click', () => {
      const textbox = document.createElement('div');
      textbox.contentEditable = true;
      textbox.className = 'textbox';
      textbox.style.left = '70px';
      textbox.style.top = '70px';
      textbox.style.width = '150px';
      textbox.style.height = '30px';
      textbox.textContent = 'Edit me';

      makeDraggableResizable(textbox);

      pdfContainer.appendChild(textbox);
      // Bring textbox to front
      textbox.style.zIndex = 20;
    });

    // Make div draggable and resizable inside container
    function makeDraggableResizable(element) {
      let isDragging = false;
      let offsetX, offsetY;

      element.addEventListener('mousedown', e => {
        if (e.target !== element) return;
        isDragging = true;
        offsetX = e.clientX - element.getBoundingClientRect().left;
        offsetY = e.clientY - element.getBoundingClientRect().top;
        element.style.cursor = 'grabbing';
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        element.style.cursor = 'move';
      });

      document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        let x = e.clientX - offsetX - pdfContainer.getBoundingClientRect().left;
        let y = e.clientY - offsetY - pdfContainer.getBoundingClientRect().top;

        // Keep inside container bounds
        x = Math.max(0, Math.min(x, pdfContainer.clientWidth - element.offsetWidth));
        y = Math.max(0, Math.min(y, pdfContainer.clientHeight - element.offsetHeight));

        element.style.left = x + 'px';
        element.style.top = y + 'px';
      });
    }

    savePdfBtn.addEventListener('click', async () => {
      if (!pdfDoc) return alert('Load a PDF first');

      const pdfBytes = await pdfDoc.getData();
      const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);

      const page = pdfLibDoc.getPage(0);
      const { width, height } = page.getSize();

      // Draw whiteouts first (to cover old text)
      document.querySelectorAll('.whiteout').forEach(box => {
        const left = parseFloat(box.style.left);
        const top = parseFloat(box.style.top);
        const boxWidth = box.offsetWidth;
        const boxHeight = box.offsetHeight;

        const x = (left / pdfContainer.clientWidth) * width;
        const y = height - ((top + boxHeight) / pdfContainer.clientHeight) * height;
        const w = (boxWidth / pdfContainer.clientWidth) * width;
        const h = (boxHeight / pdfContainer.clientHeight) * height;

        page.drawRectangle({
          x, y,
          width: w,
          height: h,
          color: PDFLib.rgb(1, 1, 1),
          borderColor: PDFLib.rgb(1, 1, 1),
          borderWidth: 0,
          opacity: 1,
        });
      });

      // Then draw textboxes on top
      document.querySelectorAll('.textbox').forEach(tb => {
        const left = parseFloat(tb.style.left);
        const top = parseFloat(tb.style.top);
        const tbWidth = tb.offsetWidth;
        const tbHeight = tb.offsetHeight;
        const text = tb.textContent;

        const x = (left / pdfContainer.clientWidth) * width;
        const y = height - ((top + tbHeight) / pdfContainer.clientHeight) * height;

        page.drawText(text, {
          x,
          y,
          size: 12,
          color: PDFLib.rgb(0, 0, 1),
          maxWidth: (tbWidth / pdfContainer.clientWidth) * width,
          lineHeight: 14,
        });
      });

      const newPdfBytes = await pdfLibDoc.save();

      // Download new PDF
      const blob = new Blob([newPdfBytes], {type: 'application/pdf'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'edited.pdf';
      link.click();
    });
  </script>
</body>
</html>
