<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF Editor + Whiteout/Text Boxes</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; }
    #pdf-container {
      position: relative;
      border: 1px solid #ccc;
      margin-top: 1em;
      width: 600px;
      height: 800px;
      overflow: hidden;
    }
    #pdf-canvas {
      border: 1px solid black;
      display: block;
    }
    .annotation {
      position: absolute;
      box-sizing: border-box;
      resize: both;
      overflow: auto;
      user-select: text;
    }
    .whiteout, .textbox {
      cursor: move;
    }
    .whiteout {
      background: white;
      border: 1px solid #555;
      z-index: 10;
    }
    .textbox {
      border: 1px solid blue;
      background: rgba(255,255,255,0.85);
      padding: 2px 5px;
      outline: none;
      z-index: 20;
      min-width: 40px;
      min-height: 20px;
    }
    #controls {
      margin-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <h1>Welcome to EditThisPDF.com</h1>
  <div id="controls">
    <input type="file" id="upload" accept="application/pdf" />
    <button id="add-whiteout" disabled>Add Whiteout</button>
    <button id="add-textbox" disabled>Add Text Box</button>
    <button id="save-pdf" disabled>Save PDF</button>
  </div>
  
  <div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'] || window['pdfjsLib'] || window.pdfjsLib;
    // Set worker src
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

    const uploadInput = document.getElementById('upload');
    const addWhiteoutBtn = document.getElementById('add-whiteout');
    const addTextboxBtn = document.getElementById('add-textbox');
    const savePdfBtn = document.getElementById('save-pdf');
    const pdfContainer = document.getElementById('pdf-container');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');

    let pdfDoc = null;
    let pageViewport = null;
    let scale = 1.5;

    uploadInput.addEventListener('change', async (e) => {
      console.log('File selected');
      const file = e.target.files[0];
      if (!file) {
        console.log('No file');
        return;
      }
      if (file.type !== 'application/pdf') {
        alert('Please upload a PDF file');
        return;
      }
      const arrayBuffer = await file.arrayBuffer();
      console.log('Loaded arrayBuffer, size:', arrayBuffer.byteLength);
      try {
        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        pdfDoc = await loadingTask.promise;
        console.log('PDF loaded, pages:', pdfDoc.numPages);
      } catch (err) {
        console.error('Error loading PDF:', err);
        alert('Failed to load PDF');
        return;
      }

      // Render page 1
      await renderPage(1);
      addWhiteoutBtn.disabled = false;
      addTextboxBtn.disabled = false;
      savePdfBtn.disabled = false;
      // Remove previous annotations if any
      document.querySelectorAll('.annotation').forEach(el => el.remove());
    });

    async function renderPage(pageNum) {
      if (!pdfDoc) {
        console.log('No pdfDoc');
        return;
      }
      const page = await pdfDoc.getPage(pageNum);
      pageViewport = page.getViewport({ scale });

      canvas.width = pageViewport.width;
      canvas.height = pageViewport.height;
      pdfContainer.style.width = canvas.width + 'px';
      pdfContainer.style.height = canvas.height + 'px';

      const renderContext = {
        canvasContext: ctx,
        viewport: pageViewport
      };
      await page.render(renderContext).promise;
      console.log('Page rendered');
    }

    // Add Whiteout
    addWhiteoutBtn.addEventListener('click', () => {
      const wo = document.createElement('div');
      wo.className = 'annotation whiteout';
      wo.style.left = '60px';
      wo.style.top = '60px';
      wo.style.width = '150px';
      wo.style.height = '50px';
      makeDraggableResizable(wo);
      pdfContainer.appendChild(wo);
    });

    // Add Text Box
    addTextboxBtn.addEventListener('click', () => {
      const tb = document.createElement('div');
      tb.className = 'annotation textbox';
      tb.contentEditable = true;
      tb.style.left = '70px';
      tb.style.top = '70px';
      tb.style.width = '150px';
      tb.style.height = '30px';
      tb.innerText = 'Edit me';
      makeDraggableResizable(tb);
      pdfContainer.appendChild(tb);
      tb.focus();
    });

    // Draggable & resizable function
    function makeDraggableResizable(el) {
      let isDragging = false;
      let startX, startY, startLeft, startTop;

      el.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const rect = el.getBoundingClientRect();
        // relative to container
        const contRect = pdfContainer.getBoundingClientRect();
        startLeft = rect.left - contRect.left;
        startTop = rect.top - contRect.top;
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        let x = e.clientX - pdfContainer.getBoundingClientRect().left - (startX - startLeft - pdfContainer.getBoundingClientRect().left);
        let y = e.clientY - pdfContainer.getBoundingClientRect().top - (startY - startTop - pdfContainer.getBoundingClientRect().top);
        // simpler: directly compute
        x = e.clientX - startX + startLeft;
        y = e.clientY - startY + startTop;

        // Clip boundaries
        x = Math.max(0, Math.min(x, pdfContainer.clientWidth - el.offsetWidth));
        y = Math.max(0, Math.min(y, pdfContainer.clientHeight - el.offsetHeight));

        el.style.left = x + 'px';
        el.style.top = y + 'px';
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      // Also let resize via CSS resize handle (bottom-right), already enabled via style
    }

    savePdfBtn.addEventListener('click', async () => {
      if (!pdfDoc) {
        alert('No PDF loaded');
        return;
      }
      const pdfBytes = await pdfDoc.getData();
      const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);
      const page = pdfLibDoc.getPage(0);
      const { width, height } = page.getSize();

      // Whiteouts first
      document.querySelectorAll('.whiteout').forEach(wo => {
        const left = parseFloat(wo.style.left);
        const top = parseFloat(wo.style.top);
        const w = wo.offsetWidth;
        const h = wo.offsetHeight;

        const x = (left / pdfContainer.clientWidth) * width;
        const y = height - ((top + h) / pdfContainer.clientHeight) * height;

        const rect = pdfLibDoc.getPage(0).drawRectangle({
          x, y,
          width: (w / pdfContainer.clientWidth) * width,
          height: (h / pdfContainer.clientHeight) * height,
          color: PDFLib.rgb(1,1,1),
          borderColor: PDFLib.rgb(1,1,1),
          borderWidth: 0,
          opacity: 1
        });
      });

      // Text boxes
      document.querySelectorAll('.textbox').forEach(tb => {
        const left = parseFloat(tb.style.left);
        const top = parseFloat(tb.style.top);
        const w = tb.offsetWidth;
        const h = tb.offsetHeight;
        const text = tb.innerText;

        const x = (left / pdfContainer.clientWidth) * width;
        const y = height - ((top + h) / pdfContainer.clientHeight) * height;

        page.drawText(text, {
          x,
          y,
          size: 12,
          color: PDFLib.rgb(0,0,1),
          maxWidth: (w / pdfContainer.clientWidth) * width,
          lineHeight: 14
        });
      });

      const newPdfBytes = await pdfLibDoc.save();
      const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'edited.pdf';
      link.click();
    });
  </script>
</body>
</html>
